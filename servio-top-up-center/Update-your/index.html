<!DOCTYPE html>
<html lang="ar" dir="rtl"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servio - Order Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-light: #f8fbff; --border-gray: #e2e8f0; --text-dark: #1a202c;
            --primary-blue: #2563eb; --accent: #000000; --success-green: #10b981;
            --error-red: #ef4444; --bg-gray: #f1f5f9;
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-gray); display: flex; justify-content: center; }
        .container-wrapper { width: 100%; display: flex; justify-content: center; }
        .main-container { width: 100%; max-width: 100%; min-height: 100vh; background-color: #f7fafc; display: flex; flex-direction: column; }

        @media (min-width: 481px) {
            .main-container { max-width: 800px; margin: 20px; border-radius: 20px; min-height: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        }

        header { 
            width: 100%; height: 65px; background-color: var(--bg-light); border-bottom: 1px solid var(--border-gray); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 12px; box-sizing: border-box; 
            position: sticky; top: 0; z-index: 1000;
        }

        .brand-section { display: flex; align-items: center; }
        .logo-img { height: 28px; width: auto; }
        .v-line { width: 1px; height: 22px; background-color: #cbd5e0; margin: 0 10px; }
        .title-box { display: flex; flex-direction: column; }
        .title-box span { font-size: 10px; font-weight: 800; color: var(--text-dark); line-height: 1.1; }

        .info-display-wrapper { display: flex; align-items: center; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0 12px; height: 34px; gap: 5px; }
        .display-text { font-size: 10px; font-weight: 700; color: #64748b; display: flex; align-items: center; gap: 5px; }

        .content-area { padding: 20px 16px; flex: 1; }
        
        /* تصميم المحفظة */
        .wallet-container {
            background: #ffffff; border-radius: 20px; padding: 16px 20px; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1.5px solid var(--border-gray);
        }
        .wallet-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .wallet-amount { font-size: 24px; font-weight: 800; color: var(--primary-blue); font-family: 'Inter', monospace; }
        .wallet-icon-box { width: 42px; height: 42px; background: #eff6ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid #dbeafe; }
        .wallet-icon-box svg { width: 22px; height: 22px; fill: var(--primary-blue); }

        .order-card { background: #ffffff; border-radius: 24px; border: 1px solid #e2e8f0; padding: 24px; }
        .form-grid { display: flex; flex-direction: column; gap: 18px; }
        .field .label { font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 8px; display: block; }
        .input-box { display: flex; align-items: center; background: #ffffff; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 0 14px; height: 52px; }
        .input-box input { flex: 1; border: none; outline: none; font-size: 14px; font-weight: 600; color: var(--text-dark); background: transparent; }
        
        .price-container { background: #f8fafc; border-radius: 16px; padding: 16px; display: flex; justify-content: space-between; border: 1px solid #e2e8f0; }
        .price-value { font-size: 20px; font-weight: 800; color: var(--primary-blue); }

        #payBtn { width: 100%; height: 56px; border: none; border-radius: 14px; background: #000; color: #fff; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        #payBtn:disabled { background: #444; }
        
        .error-state { border-color: var(--error-red) !important; background-color: #fff5f5; }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <div class="main-container">
            <header>
                <div class="brand-section">
                    <img src="https://i.postimg.cc/KvMWmkZw/servio.png" class="logo-img">
                    <div class="v-line"></div>
                    <div class="title-box">
                        <span id="nav-t1">مركز الشحن</span>
                        <span id="nav-t2">الرسمي</span>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="wallet-container">
                    <div class="wallet-info">
                        <span class="wallet-label" id="label-balance">الرصيد المتاح</span>
                        <div class="wallet-amount" id="available-balance">$0.00</div>
                    </div>
                    <div class="wallet-icon-box">
                        <svg viewBox="0 0 24 24"><path d="M21,18V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5A2,2 0 0,1 5,3H19A2,2 0 0,1 21,5V6H12C10.89,6 10,6.9 10,8V16A2,2 0 0,0 12,18H21M12,16H22V8H12V16M16,13.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,12A1.5,1.5 0 0,1 16,13.5Z"/></svg>
                    </div>
                </div>

                <div class="order-card">
                    <div class="form-grid">
                        <div class="field">
                            <label class="label">رابط المنصة</label>
                            <div class="input-box"><input id="platformLink" readonly></div>
                        </div>

                        <div class="field">
                            <label class="label">البريد الإلكتروني</label>
                            <div class="input-box"><input id="email" type="email" placeholder="example@gmail.com"></div>
                        </div>

                        <div class="field">
                            <label class="label">الكمية</label>
                            <div class="input-box"><input id="quantity" type="text" inputmode="numeric"></div>
                        </div>

                        <div class="price-container">
                            <span class="price-label">إجمالي المستحق</span>
                            <span class="price-value" id="display-price">$0</span>
                        </div>

                        <button id="payBtn">تأكيد الطلب والدفع</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // الرابط الجديد الخاص بك (يجب أن يكون ناتج عن New Deployment)
        const scriptURL = "https://script.google.com/macros/s/AKfycbxkYXsPuXnl2gig7X-G3cV-KTkpfg7tYcZ3C0jQeNgf5TEteIwdp8I3nT9fb2Vdcyu-sA/exec";

        // دالة جلب الرصيد الحقيقي من جوجل شيت
        async function fetchWalletData() {
            const email = document.getElementById("email").value || localStorage.getItem("userGmail");
            const balanceElement = document.getElementById('available-balance');

            if (!email || !email.includes('@')) return;

            try {
                // إرسال طلب POST لجلب البيانات الحالية من الجدول
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({ gmail: email })
                });
                
                const data = await response.json();
                
                if (data && data.status === "success") {
                    const formatted = parseFloat(data.balance).toFixed(2);
                    balanceElement.innerText = `$${formatted}`;
                    localStorage.setItem("user_balance", formatted);
                }
            } catch (e) { 
                console.error("Wallet Fetch Error", e); 
            }
        }

        // تحديث السعر بناء على الكمية
        function updatePrice() {
            const qtyInput = document.getElementById("quantity");
            const displayPrice = document.getElementById("display-price");
            const unitPrice = parseFloat(localStorage.getItem("service_price")) || 0.001; // مثال لسعر الوحدة
            
            let qty = parseInt(qtyInput.value.replace(/,/g, '')) || 0;
            let total = qty * unitPrice;
            displayPrice.innerText = `$${total.toFixed(2)}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // استرجاع البيانات المحفوظة
            document.getElementById("email").value = localStorage.getItem("userGmail") || "";
            
            // جلب الرصيد فور تحميل الصفحة
            fetchWalletData();

            // مستمعات الأحداث للتحديث التلقائي
            document.getElementById("email").addEventListener('blur', fetchWalletData);
            document.getElementById("quantity").addEventListener('input', updatePrice);

            // زر الدفع
            document.getElementById("payBtn").onclick = async function() {
                const email = document.getElementById("email").value;
                const qty = document.getElementById("quantity").value;
                const balance = parseFloat(localStorage.getItem("user_balance")) || 0;
                const totalDue = parseFloat(document.getElementById("display-price").innerText.replace('$', ''));

                if (balance < totalDue) {
                    alert("عذراً، رصيدك غير كافٍ. يرجى شحن المحفظة.");
                    return;
                }

                alert("جاري معالجة الطلب...");
                // هنا تضع كود إرسال الطلب للجدول
            };
        });
    </script>
</body>
</html>
