<!DOCTYPE html>
<html lang="ar" dir="rtl"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Servio - Order Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-light: #f8fbff; 
            --border-gray: #e2e8f0; 
            --text-dark: #1a202c;
            --primary-blue: #2563eb;
            --accent: #000000;
            --success-green: #10b981;
            --error-red: #ef4444;
            --bg-gray: #f1f5f9;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-gray); 
            display: flex; justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .container-wrapper { width: 100%; display: flex; justify-content: center; }
        .main-container { 
            width: 100%; max-width: 100%; min-height: 100vh; 
            background-color: #f7fafc; display: flex; flex-direction: column; 
        }

        @media (min-width: 481px) {
            .main-container {
                max-width: 500px; /* جعل العرض أكثر انضباطاً للهواتف والأجهزة اللوحية */
                margin: 20px auto; border-radius: 24px; min-height: auto;
                box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            }
        }

        header { 
            width: 100%; height: 65px; background: rgba(248, 251, 255, 0.8);
            backdrop-filter: blur(10px); /* إضافة تأثير زجاجي */
            border-bottom: 1px solid var(--border-gray); display: flex; 
            align-items: center; justify-content: space-between; 
            padding: 0 16px; box-sizing: border-box; position: sticky; 
            top: 0; z-index: 1000;
        }

        .brand-section { display: flex; align-items: center; }
        .logo-img { height: 26px; width: auto; }
        .v-line { width: 1px; height: 20px; background-color: #cbd5e0; margin: 0 12px; }
        .title-box span { font-size: 10px; font-weight: 800; color: var(--text-dark); display: block; }

        .info-display-wrapper { 
            display: flex; align-items: center; background: #fff; 
            border: 1px solid #e2e8f0; border-radius: 10px; 
            padding: 0 10px; height: 36px; gap: 8px;
        }

        .display-text { font-size: 11px; font-weight: 700; color: #64748b; }
        .flag-icon { width: 20px; height: 14px; border-radius: 2px; object-fit: cover; }
        .mena-icon { width: 18px; height: 18px; fill: #64748b; }

        .content-area { padding: 24px 16px; flex: 1; }
        .order-card { 
            background: #ffffff; border-radius: 28px; 
            border: 1px solid #ffffff; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02), 0 10px 15px -3px rgba(0,0,0,0.03); 
            padding: 24px;
        }

        .order-header { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; }
        .order-icon-circle { 
            width: 44px; height: 44px; background: #f0f7ff; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; color: var(--primary-blue); 
        }

        .form-grid { display: flex; flex-direction: column; gap: 20px; }
        .field .label { font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px; display: block; }
        
        .input-box { 
            display: flex; align-items: center; background: #f8fafc; 
            border: 1.5px solid #edf2f7; border-radius: 16px; 
            padding: 0 14px; height: 54px; transition: var(--transition); 
        }
        .input-box:focus-within { border-color: var(--primary-blue); background: #fff; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        
        .input-box input { border: none; outline: none; background: none; font-size: 15px; font-weight: 600; color: var(--text-dark); width: 100%; }
        
        .price-container { 
            background: #f1f5f9; border-radius: 18px; padding: 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px dashed #cbd5e0;
        }
        .price-value { font-size: 22px; font-weight: 800; color: var(--primary-blue); font-family: 'Inter', sans-serif; }

        #payBtn {
            width: 100%; height: 58px; border: none; border-radius: 18px; 
            background: var(--accent); color: #fff; font-size: 16px; font-weight: 700; 
            cursor: pointer; transition: var(--transition); margin-top: 10px;
        }
        #payBtn:active { transform: scale(0.98); }
        #payBtn:disabled { background: #94a3b8; cursor: not-allowed; }

        /* حالة الخطأ الموحدة */
        .error-state { border-color: var(--error-red) !important; background-color: #fffafa !important; }

        .spinner {
            display: none; width: 22px; height: 22px; border: 3px solid rgba(255, 255, 255, 0.3); 
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        .loading .spinner { display: block; }
        .loading #btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <div class="main-container">
            <header>
                <div class="brand-section">
                    <img src="https://i.postimg.cc/KvMWmkZw/servio.png" class="logo-img" alt="Logo">
                    <div class="v-line"></div>
                    <div class="title-box">
                        <span id="nav-t1"></span>
                        <span id="nav-t2"></span>
                    </div>
                </div>
                <div class="info-display-wrapper">
                    <div id="flag-display"></div>
                    <div class="display-text">
                        <span id="label-reg"></span>
                        <span id="label-lng" style="margin-right:4px; padding:2px 4px; background:#f1f5f9; border-radius:4px;"></span>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-icon-circle">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                        </div>
                        <div class="order-title" id="text-order-details" style="font-size: 18px; font-weight: 800;"></div>
                    </div>

                    <div class="form-grid">
                        <div class="field">
                            <label class="label" id="label-platform"></label>
                            <div class="input-box" id="box-platform">
                                <input id="platformLink" type="text" spellcheck="false">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label" id="label-category"></label>
                            <div class="input-box" id="box-category" style="cursor:pointer" onclick="goToCategory()">
                                <span id="category" style="font-size: 14px; font-weight: 600;"></span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                            <div class="field">
                                <label class="label" id="label-quantity"></label>
                                <div class="input-box" id="box-quantity">
                                    <input id="quantity" type="number" inputmode="numeric" value="1" min="1">
                                </div>
                            </div>
                            <div class="field">
                                <label class="label" id="label-email"></label>
                                <div class="input-box" id="box-email">
                                    <input id="email" type="email" placeholder="mail@example.com">
                                </div>
                            </div>
                        </div>

                        <div class="price-container">
                            <span class="price-label" id="label-total"></span>
                            <span class="price-value" id="display-price">$0.00</span>
                        </div>

                        <button id="payBtn">
                            <span id="btn-text"></span>
                            <div class="spinner"></div>
                        </button>
                        
                        <div class="security-badge" style="text-align:center; font-size:11px; color:#94a3b8; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="#10b981"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
                            <span id="safe-text"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbxJ0oupWVWSzpDrnEELES_4xlX-wWB05dgr7SFuww9JmjfFJkRj-nCrqWCUnmkSgABI/exec";

        // توحيد ترجمات النظام
        const translations = {
            ar: {
                navT1: "مركز الشحن", navT2: "الرسمي",
                orderTitle: "تفاصيل طلبك",
                labelPlatform: "رابط المنصة / الحساب",
                labelCat: "الخدمة المختارة",
                labelQty: "الكمية",
                labelEmail: "البريد الإلكتروني",
                total: "الإجمالي",
                btn: "إتمام عملية الدفع",
                safe: "تشفير SSL آمن 100%",
                placeholderCat: "اختر الخدمة من هنا...",
                regions: ["الشرق الأوسط", "الجزائر", "مصر", "العراق", "المغرب", "نيجيريا", "عمان", "فلسطين", "قطر", "السعودية", "تونس", "الإمارات", "دولي"]
            },
            en: {
                navT1: "Official", navT2: "Top Up",
                orderTitle: "Order Summary",
                labelPlatform: "Platform Link",
                labelCat: "Service",
                labelQty: "Qty",
                labelEmail: "Email",
                total: "Total Amount",
                btn: "Pay Now",
                safe: "Secure 256-bit SSL Payment",
                placeholderCat: "Select a service...",
                regions: ["MENA", "Algeria", "Egypt", "Iraq", "Morocco", "Nigeria", "Oman", "Palestine", "Qatar", "Saudi Arabia", "Tunisia", "UAE", "Global"]
            }
        };

        const flags = {
            mena: `<svg class="mena-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>`,
            algeria: "dz", egypt: "eg", iraq: "iq", morocco: "ma", nigeria: "ng", oman: "om", palestine: "ps", qatar: "qa", saudi: "sa", tunisia: "tn", uae: "ae",
            other: `<svg class="mena-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>`
        };

        const regionKeys = ["mena", "algeria", "egypt", "iraq", "morocco", "nigeria", "oman", "palestine", "qatar", "saudi", "tunisia", "uae", "other"];

        function calculateTotalPrice() {
            const unitPrice = parseFloat(localStorage.getItem("service_price")) || 0;
            const qty = Math.max(1, parseFloat(document.getElementById("quantity").value) || 0);
            const total = (unitPrice * qty).toFixed(2);
            document.getElementById("display-price").innerText = `$${total}`;
            return total;
        }

        function updateUI() {
            const lang = localStorage.getItem('pref_lang') || 'ar';
            const regIdx = parseInt(localStorage.getItem('pref_reg_idx')) || 0;
            const t = translations[lang];

            document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
            
            // تحديث النصوص
            document.getElementById('nav-t1').innerText = t.navT1;
            document.getElementById('nav-t2').innerText = t.navT2;
            document.getElementById('label-lng').innerText = lang.toUpperCase();
            document.getElementById('label-reg').innerText = t.regions[regIdx];
            document.getElementById('text-order-details').innerText = t.orderTitle;
            document.getElementById('label-platform').innerText = t.labelPlatform;
            document.getElementById('label-category').innerText = t.labelCat;
            document.getElementById('label-quantity').innerText = t.labelQty;
            document.getElementById('label-email').innerText = t.labelEmail;
            document.getElementById('label-total').innerText = t.total;
            document.getElementById('btn-text').innerText = t.btn;
            document.getElementById('safe-text').innerText = t.safe;

            // تحديث العلم بشكل أنظف
            const flagKey = regionKeys[regIdx];
            const flagBox = document.getElementById('flag-display');
            if (['mena', 'other'].includes(flagKey)) {
                flagBox.innerHTML = flags[flagKey];
            } else {
                flagBox.innerHTML = `<img src="https://flagcdn.com/${flags[flagKey]}.svg" class="flag-icon">`;
            }

            // تحديث الفئة المختارة
            const chosen = localStorage.getItem("chosen_service");
            const catSpan = document.getElementById("category");
            catSpan.innerText = chosen || t.placeholderCat;
            catSpan.style.color = chosen ? "var(--text-dark)" : "#94a3b8";

            // استعادة البيانات المؤقتة
            const params = new URLSearchParams(window.location.search);
            document.getElementById("platformLink").value = params.get('link') || localStorage.getItem("temp_link") || "";
            document.getElementById("email").value = localStorage.getItem("temp_email") || "";
            document.getElementById("quantity").value = localStorage.getItem("temp_qty") || 1;
            
            calculateTotalPrice();
        }

        function goToCategory() {
            // حفظ الحالة قبل الانتقال
            localStorage.setItem("temp_link", document.getElementById("platformLink").value);
            localStorage.setItem("temp_email", document.getElementById("email").value);
            localStorage.setItem("temp_qty", document.getElementById("quantity").value);
            location.href = `../Category/`;
        }

        document.getElementById("quantity").oninput = calculateTotalPrice;

        document.getElementById("payBtn").onclick = async function() {
            const btn = this;
            const fields = {
                link: document.getElementById("platformLink"),
                email: document.getElementById("email"),
                qty: document.getElementById("quantity"),
                cat: document.getElementById("box-category")
            };

            // التحقق من صحة البيانات (Validation)
            let isValid = true;
            Object.values(fields).forEach(f => (f.closest('.input-box') || f).classList.remove('error-state'));

            if (!fields.link.value.trim()) { fields.link.parentElement.classList.add('error-state'); isValid = false; }
            if (!fields.email.value.includes('@')) { fields.email.parentElement.classList.add('error-state'); isValid = false; }
            if (!localStorage.getItem("chosen_service")) { fields.cat.classList.add('error-state'); isValid = false; }

            if (!isValid) return;

            // بدء التحميل
            btn.classList.add('loading');
            btn.disabled = true;

            const payload = {
                platformLink: fields.link.value,
                category: localStorage.getItem("chosen_service"),
                quantity: fields.qty.value,
                charge: document.getElementById("display-price").innerText,
                gmail: fields.email.value,
                timestamp: new Date().toISOString()
            };

            try {
                // استخدام إرسال البيانات بشكل آمن
                await fetch(scriptURL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                // مسح البيانات بعد النجاح
                ["temp_link", "temp_email", "temp_qty", "chosen_service"].forEach(k => localStorage.removeItem(k));
                
                setTimeout(() => {
                    location.href = `Confirm/?link=${encodeURIComponent(payload.platformLink)}`;
                }, 800);
            } catch (e) {
                console.error("Submission error", e);
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        window.onload = updateUI;
    </script>
</body>
</html>
